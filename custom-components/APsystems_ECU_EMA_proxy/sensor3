# Platform for sensor integration
from __future__ import annotations

from homeassistant.components.sensor import (
    SensorDeviceClass,
    SensorEntity,
    SensorStateClass,
)
from homeassistant.const import TEMP_CELSIUS
from homeassistant.core import HomeAssistant
from homeassistant.helpers.entity_platform import AddEntitiesCallback
from homeassistant.helpers.typing import ConfigType, DiscoveryInfoType

import logging
LOGGER = logging.getLogger(__name__)

# added
import socket
import socketserver
from socketserver import BaseRequestHandler
import threading
host = "172.16.0.19"
port = 8996

def create_listen_socket(host, port):
    LOGGER.warning ("2. Setup the sockets our server will receive connection requests on...")
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    sock.bind((host, port))
    sock.listen(100)
    return sock

def recv_msg(sock):
    # Wait for data to arrive on the socket
    recvd = sock.recv(4096)
    LOGGER.warning (f"Received: {recvd}")
    return recvd

def handle_client(sock, addr):
    LOGGER.warning("Receive data from the client via sock and echo it back")
    try:
        msg = recv_msg(sock) # Blocks until received complete message
        LOGGER.warning(f"Received from {addr}: {msg})
    except (ConnectionError, BrokenPipeError):
        LOGGER.warning("Socket error")
    finally:
        handle_client(client_sock, addr)        # loop back to recv_msg
    #     print('Closed connection to {}'.format(addr))
    #     sock.close()

# end added



def setup_platform(
    hass: HomeAssistant,
    config: ConfigType,
    add_entities: AddEntitiesCallback, discovery_info: DiscoveryInfoType | None = None) -> None:

    # Set up the sensor platform
    add_entities([apsystems_ecu2ema_proxy()])
    LOGGER.warning("1. Entities added...")

    listen_sock = create_listen_socket(host, port)
    addr = listen_sock.getsockname()
    LOGGER.warning(f"3. Listening on: {addr}")
    while True:
        client_sock, addr = listen_sock.accept()
        LOGGER.warning(f"Connection from: {addr}")
        handle_client(client_sock, addr)
# end added

class apsystems_ecu2ema_proxy(SensorEntity):
    # Representation of a Sensor

    _attr_name = "Example Temperature"
    _attr_native_unit_of_measurement = TEMP_CELSIUS
    _attr_device_class = SensorDeviceClass.TEMPERATURE
    _attr_state_class = SensorStateClass.MEASUREMENT

    def update(self) -> None:
        # Fetch new state data for the sensor. This is the only method that should fetch new data for Home Assistant.
        LOGGER.warning("Sensor update")
        self._attr_native_value = 23

